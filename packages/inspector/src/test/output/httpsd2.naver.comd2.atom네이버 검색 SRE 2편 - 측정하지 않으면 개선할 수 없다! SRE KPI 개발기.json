{"company":{"imageUrl":"/companyImages/naver.ico","name":"네이버","rssUrl":"https://d2.naver.com/d2.atom","href":"https://d2.naver.com/d2.atom","basePath":"https://d2.naver.com"},"title":"네이버 검색 SRE 2편 - 측정하지 않으면 개선할 수 없다! SRE KPI 개발기","createdAt":"2023-01-27T10:25:36Z","description":"\nMTTM 개발기\n개발 배경\nMTTR이란\n전사 장애 시스템의 장애 관제 방식\nMTTR 지표 사용의 한계\n새로운 지표 MTTM\nTTM 지표 측정\n끝날 때까지 끝난 게 아닌 SRE KPI 개발 여정\nKPI 개발 끝, 행복 시작?\n평균의 함정\n새로운 지표 CTTM, DTTM의 등장\n앞으로의 과제\n\n\n지난 글에서 차세대 검색 모니터링 시스템 개발 여정을 다루었습니다. 이번 편에서는 SRE KPI 개발기에 대해 이야기해보려고 합니다.\n\n검색 SRE팀에서는 검색 서비스의 장애를 예방하고 서비스 신뢰도를 높이기 위해 여러 관련 시스템도 개발하고 on-call 업무도 진행하는 등 이곳저곳에서 바쁘게 움직이고 있습니다. 저희의 이런 노력과 검색 서비스 모든 담당자분들의 노고 덕분에 검색 서비스 신뢰도와 안정성은 계속해서 개선되고 있는데요, 그렇다면 얼마나 개선되었는지는 어떻게 알 수 있을까요? 단순히 운이 좋아서 수치가 개선된 것이 아니라 여러 사람들의 노력으로 인해 좋아졌다는 것은 어떻게 보여줄 수 있을까요?\n\n이런 물음에 답하기 위해 검색 SRE팀에서는 검색 서비스의 건강도를 측정하고, 장애 상황에 신속하게 대응하기 위한 여러 가지 방법을 연구하고 발전시켜나가고 있습니다. 이번 검색 SRE 2부 아티클을 통해 지난 몇 년간 내부적으로 논의하고 사용해본 방법들에 대한 이야기를 나누어보고자 합니다.\n\n우선, 검색 서비스의 건강도에 관해 이야기해보고자 합니다. 검색 서비스의 건강도란 무엇을 의미하는 걸까요? 어떤 서비스가 건강한지에 대해서는 어떻게 알 수 있을까요? 가장 간단하고 직접적인 방법은 서비스를 운영하는 장비의 지표(CPU, 메모리, 네트워크 TX/RX 등)를 확인하는 방법이 있을 것입니다. 그런데, 네이버 검색 서비스는 매우 많은 시스템으로 구성되어 있고, 따라서 모든 장비의 지표를 일일이 확인하여 서비스의 건강도를 파악하는 것은 몹시 고되고 비효율적인 작업입니다.\n\n숲에 있는 나무 하나하나의 건강을 챙기는 것도 중요하지만, 숲 전체의 건강을 챙기는 것 역시 중요합니다. 이는 곧, 저희 검색 SRE팀의 목표 그리고 존재 의의라고 할 수 있겠습니다. 좀 더 직관적으로 서비스 전체의 건강도를 파악하기 위해 저희가 시도했던 노력, 그리고 그 과정에서 도출한 지표들에 대해 소개해드리겠습니다.\n\n\n\nMTTM 개발기\n\n\n\n개발 배경\n\n검색 SRE팀에서는 장애율(장애 발생 건수/변경 공지 건수) 지표를 KPI로 사용하고 있다. 서비스의 장애 대부분이 변경 배포 와중에, 혹은 배포 이후 발생하는 것에서 착안한 지표이다. 매우 단순하면서도 효과적으로 검색 서비스 전반의 건강도를 알 수 있는 지표이다.\n\n\n\n검색 SRE가 지원 중인 부서 기준으로 2019년부터 장애율 1% 이하를 유지하고 있다. 특히 2020년에는 0.45% 장애율을 달성했고 이는 변경 공지 200건당 약 1건 이하의 장애 발생을 의미한다. 장애율을 줄이는 것은 중요하지만 장애율을 0%로 줄이는 것은 불가능한 일이기에, 1% 이하의 장애율은 현실적으로 달성하기 어려운 수치를 이루어낸 것이며 앞으로의 지표 개선은 한계가 있다고 판단했다. 따라서 자연스럽게 새로운 KPI 개발의 필요성이 대두되었다.\n\n가장 먼저 논의된 지표는 MTTR(mean time to recovery)이다.\n\n\n\nMTTR이란\n\n장애가 발생하지 않도록 하는 것도 중요하지만, 장애가 발생했을 때 신속하게 복구하는 것도 중요하다. 장애가 발생했을 때 복구까지 걸리는 시간의 평균을 MTTR이라고 하며, 이 지표를 줄여나간다는 것은 신속한 장애 대처 능력을 갖춘다는 것을 의미한다. MTTR은 네이버 전사 장애 시스템에 기록된 장애 티켓의 장애 발생 시각~복구 완료 시각을 하나의 TTR 데이터로 측정하여 산출한다.\n\n위 방식을 통해 검색 SRE가 지원 중인 부서 기준으로 2018년 이후의 MTTR을 살펴보면 매년 1시간이 넘어간다는 것을 확인했다. 실제로 검색 서비스에서 1시간 이상 장애가 지속되었던 케이스는 없었기 때문에 해당 MTTR은 신속한 장애 복구 능력을 나타내는 지표로 사용하기에는 어렵다는 것을 알 수 있다. 먼저 전사 장애 시스템의 장애 관제 방식에 대해서 살펴보겠다.\n\n\n\n전사 장애 시스템의 장애 관제 방식\n\n먼저 전사 장애 시스템에서 장애를 감지하는 경로는 3가지이다.\n\n\n서비스 모니터링 툴을 이용하여 실시간으로 장애 감지\n고객센터로 인입된 고객 문의나 자체 판단 기준을 통해 감지\n장애센터로 인입되는 전사 임직원의 문의를 통해 감지\n\n\n이 중 엔지니어의 개입 없이 자동적으로 장애를 감지하는 방법은 서비스 모니터링 툴을 이용한 장애 감지이다. 그렇다면 현재 서비스 모니터링 툴에서는 검색 서비스에 대해서 어떤 방식으로 장애 감지를 하고 있을까? 모니터링하고자 하는 특정 URL을 지정하고, 해당 페이지에서 등장해야 하는 오브젝트를 지정함으로써 해당 오브젝트가 존재하는지 판단한다. 즉, 특정 주기마다 해당 페이지의 정상 출력 여부에 대한 모니터링을 진행하고 있다.\n\n예를 들면, 이미지 검색이 잘 되는지 확인하기 위해 아래와 같이 '네이버'라는 테스트 검색어로 검색을 진행하고 이미지 탭에서 결과가 잘 나오는지 확인할 수 있다.\n\n\n\n\n\nMTTR 지표 사용의 한계\n\n위와 같은 방식으로 장애를 감지하고, 서비스 장애의 복구 시간을 나타내는 MTTR을 검색 SRE의 신속한 장애 복구 능력을 나타내는 지표로 사용하는 것에는 몇 가지 어려움이 있었다.\n\n\n장애 감지 사각지대 존재\n\n담당자가 위 감지 조건을 직접 튜닝해야 한다. 감지 조건 튜닝을 잘한 서비스는 그만큼 장애가 잘 관측되지만, 그렇지 않은 서비스는 잘 관측되지 않는다.\n새로 출시된 서비스일수록 상대적으로 조건 튜닝의 디테일이 부족하기 때문에 감지의 사각지대가 생길 수 있다.\n서비스별 장애 감지 조건의 차이와 서비스/시스템 관점에서의 지표 산출\n\n검색 SRE는 모든 서비스의 장애 복구 시간을 한눈에 볼 수 있는 특정 지표로 환산하고자 한다. 따라서 '서비스'의 관점에서 모두 각기 다른 감지 조건을 설정하여 장애를 감지하고 이를 지표로 산출하기보다는, '시스템'의 관점에서 일관성 있고 객관적인 방식의 장애 감지와 그에 따른 지표 산출이 필요하다고 판단했다.\n표본 수 부족\n\n절대적인 표본 수 부족\n검색 SRE가 지원 중인 부서 기준 매년 장애 건수는 00건 이하이다. 표본의 수가 부족하다는 것은 결국 통계적으로 신뢰도가 낮다는 문제로 연결된다.\n표본 수의 감소 추세\n위 표본 수가 부족한 문제는 검색 SRE 활동을 통해 장애율을 줄여나감에 따라 더욱 심해진다. 기존 KPI에서 장애 발생 건수/변경 공지 건수를 줄여 1% 이하의 장애율을 달성했는데, 이 말은 결국 MTTR의 표본인 장애 건수의 감소를 의미한다.\n이상값(outlier)에 의한 지표의 변화\n분석한 장애 데이터의 복구 시간은 최소 0분~최대 0000분으로 범위가 매우 넓다. 표본이 적다는 문제는 worst case의 이상값에 의한 값의 왜곡 현상을 심화시킨다.\n\n\n\n\n새로운 지표 MTTM\n\n따라서 위 3가지 문제점을 해결하며, 신속한 장애 복구 능력을 지표화할 수 있는 방식에 대해서 고민했다. 이때 '장애의 발생~복구만이 아닌 서버 이상 증상의 감지~완화를 측정 데이터로 사용하면 어떨까?'라는 아이디어에서 MTTM의 개념이 등장했다.\n\n\n\nMTTM(mean time to mitigation)이란 서버의 이상 증상이 감지되어 경보가 발생한 시점부터 증상의 완화(mitigation) 시점까지 걸린 시간의 평균을 의미한다.\n\nMTTM은 검색 모니터링 시스템의 Event 데이터를 사용하여 지표를 산출했다.(1편에서 소개한 바로 그 검색 모니터링 시스템이다.) 검색 모니터링 시스템에서는 장애 및 이상 증상에 대한 일관성있고 고도화된 감지를 통해 사용자에게 Event를 알려준다. 또한 수년간의 이상 증상에 대한 데이터가 아카이빙 되어있으며, 표본 수도 많고 정확도도 높다. Event는 아래와 같은 종류가 있으며, 각 Event의 발동과 해제 기준은 모든 검색 서비스에 동일하게 적용된다.\n\n\n트래픽 경보\n가용량 부족\n시간 초과 발생\n평균 응답 시간 지연\n\n\n\n\nTTM 지표 측정\n\n전사 장애 기준에는 미치지 못했으나 검색 모니터링 시스템에 관측된 한 가지 이상 증상 케이스를 예로 설명하겠다.(경보 시간, CPU 사용률 등 구체적인 수치는 예시이다.) 잘못된 배포로 인하여 특정 서버의 CPU 사용률이 급격히 상승했고 이에 따라 연결 시간 초과(connection timeout)이 발생했던 케이스이다. 운영자는 이를 인지하여 수 분내에 롤백 조치를 했다.\n\n\n\n검색 모니터링 시스템에서는 해당 Event를 가용량이 부족한 이상 증상으로 규정하고 있다. 이에 따라 임계점(threshold)을 넘어간 시점에 경보를 발생시키고, 증상이 완화된 시점에는 경보를 해제한다. 우리는 경보의 발동부터 해제까지를 time to mitigation(완화까지의 시간)으로 정하고, 모든 이상 증상의 TTM 평균인 MTTM(mean time to mitigation)을 사용한다.\n\n해당 케이스의 경우 17시 25분에 경보가 발동하여 17시 35분에 해제되었으므로 TTM은 10분으로 계산된다.\n\n\n\n더욱 자세한 내용은 해당 주제로 발표를 진행했던 DEVIEW 2021 세션에서 확인할 수 있다.\n\n\n\n끝날 때까지 끝난 게 아닌 SRE KPI 개발 여정\n\n\n\nKPI 개발 끝, 행복 시작?\n\n이렇게 MTTM이라는 새로운 지표를 만들고 적용한 지 일 년이 흘러 살펴본 지표는 아래와 같았다.\n\n\n\n그런데 정말로 \"최근 검색 서비스의 이상 증상이 해소되기까지 평균적으로 약 10분 정도 소요된다\"라고 해석해도 괜찮은 걸까?\n\n\n\n평균의 함정\n\n경험을 통해 대강 짐작하고 있는 경보의 지속 시간과 'MTTM 5~10분'은 검색 SRE 입장에서는 조금 괴리가 있다고 느껴졌다. 왜 그런지 경보 데이터를 살펴보니 일시적으로 1~2분 튀었다가 경보가 해제되는 경우가 전체 경보의 절반 이상을 차지하고 있었고, 그에 따라 우리는 MTTM이 더 낮은 수치를 보여줄 것이라고 기대하고 있던 것이다. 이상 증상이 해소되기까지 오래 걸리는 몇몇 이상값으로 인해 10분이라는 수치로 계산되었기에, 이는 '평균의 함정'이라고도 해석이 가능했다.\n\n그리고 1~2분 경보 데이터는 정말로 '경보'일까? 아니면 일시적으로 튀는 이상 증상이니 경보 상황으로 보지 않아야 하는걸까? 2분 이하 경보 케이스를 하나씩 살펴보면 실제로 장애로 이어질 수 있었던 경보 상황은 많지 않았고, 배포나 하드웨어 이슈 등으로 일시적으로 수치가 튀었다가 다시 정상으로 돌아오는 경우가 많았다. 그렇지만 실제로 장애였던 케이스도 분명 존재했다.\n\n논의 끝에 대표 MTTM은 10분 이상의 경보 데이터를 기준으로 계산하는 것으로 결정했다. 이러한 기준은 10분 이상의 경보와 이상 증상에 대해서 더 집중해서 먼저 살펴보겠다는 의지가 담겨 있기도 하다.\n\n10분 이상의 경보 데이터로 MTTM을 다시 계산하면 아래와 같다. 전체 TTM의 평균보다 최대 6배 정도 수치가 증가한다.\n\n\n\n그런데 TTM >= 10분 MTTM을 본다고 하더라도, 아래 두 가지 문제는 여전히 고민이 필요하다.\n\n\n여전히 평균값을 사용하기 때문에 '평균의 함정'에서는 벗어날 수 없다. 짧은 경보 상황이 많이 발생할수록 지표가 좋아지거나, 이상값 몇 개가 지표를 악화시키는 문제는 여전히 존재한다.\n짧은 시간 지속되는 경보 상황이 많은 것에 대해서는 \"경보 시간이 긴 것 보다는 짧은 게 좋은 것 아닌가?\"라는 생각이 자연스럽게 떠오르지만, 경보가 '많은' 것이 건강한 시스템 상황이라고 볼 수 있을지는 고민이 필요하다.\n\n\n이에 대한 예시로, 위 2020년 MTTM을 다시 살펴보면 TTM 필터링에 따라 다른 양상을 보인다는 것을 확인할 수 있다. 전체 TTM을 대상으로 한 MTTM의 경우 2019년보다 작고 2021년보다 크지만, 10분 이상 TTM을 대상으로 한 MTTM의 경우 2019년, 2021년보다 확연히 큰 값을 보여준다.\n\n그리고 10분 미만의 TTM 비율이 늘어나고 있는 것도 확인할 수 있었다. 짧은 시간의 경보가 많아지고 있는 것이다.\n\n\n\n이에 대해, MTTM 값이 낮다고 해서 시스템이 건강하다고 판단하기는 어렵다는 결론을 내렸다. 이 문제를 해결하기 위해 평균값만 보는것이 아니라 이상 증상의 규모나 빈도를 함께 살펴볼 수 있는 보조 지표를 추가해보자는 의견이 나왔다.\n\n\n\n새로운 지표 CTTM, DTTM의 등장\n\n규모를 확인할 수 있는 가장 간단한 방법은 그 합계 값을 확인하는 것이다. 우리도 이에 따라 보조 지표인 CTTM, DTTM을 만들었다.\n\n\nCTTM: 누적 TTM. TTM을 단순 합산한 것. 이상 증상의 전체 규모를 숫자 하나로 파악할 수 있음\nDTTM: Duration TTM. 경보끼리의 중복 시간을 제거해서 구한 전체 TTM 합.\n\n\n즉, 예를 들어 지속 시간 1분짜리 경보 3개가 동시에 울렸다면 CTTM은 3분, DTTM은 1분으로 계산한다.\n\n\n\n전체 합산값인 CTTM은 경보의 전체적인 규모를 파악하기 위한 지표라는 것을 알겠는데, 그렇다면 DTTM은 어떤 목적으로 만들어진 지표일까?\n\n검색 SRE에서는 200여 개가 넘는 검색 서비스가 운영되고 있고, 경보의 종류도 다양하다. 따라서 단순히 합산값만 구하면 1년 중 몇 퍼센트의 시간만큼 이상 증상이 있었는지 직관적으로 확인하기가 어렵다. 예를 들어 여러 종류의 경보가 여러 서비스에서 많이 발생한다면 연간 CTTM 기준으로 1년을 넘어가는 값이 나올 수도 있다.\n\n그러나 DTTM은 '이 시간에 이상 증상이 있었는지 없었는지'를 기준으로 하기 때문에 기준시간 대비 100%를 초과하는 값이 나올 수 없다. 이를 통해 검색 서비스 전체 *이상 증상의 budget도 확인할 수 있게된다.\n\n\n  * 이상 증상의 budget: 이상 증상 시간의 총합. 시스템 다운타임의 최대값을 뜻하는 error budget에서 착안한 단어.\n\n\n그리고 DTTM을 확인하며 각 시간에 얼마나 많은 이상 증상이 겹쳐서 일어났는지도 확인할 수 있다. 만일 같은 시간에 여러 서비스 혹은 여러 이상 증상이 동시에 나타나면 SPOF(single point of failure)과 같이 광범위하게 영향을 미치는 이상 증상이 있었다는 것을 확인할 수 있다. 이는 큰 영향을 주는 이상 증상이나 장애를 추적하고 예방하는 것에도 도움이 될 수 있을 것이라고 생각했다.\n\n\n\n\n\n위 그래프를 통해 알 수 있는 우리 시스템의 건강도 상황은 다음과 같다.\n\n\n22년을 기준으로 10분 이상의 이상 증상 평균 지속 시간은 65분이다. 이상 증상 규모는 약 1% 정도였다.\n반면 CTTM과 DTTM 두 가지 지표를 비교하면 DTTM이 더 빠르게 작아지고 있는것을 확인할 수 있다. 22년도에는 대략 0.5% 정도까지 차이가 나기도 한다. 이는 여러 서비스에서 여러 이상 증상이 동시에 발생하는 비율이 더 커지고 있음을 나타낸다고 볼 수 있다. 이상 증상이 동시에 발생한 시간과 그 내용을 확인하여, 하나의 증상이 여러 서비스에 영향을 미치고 있는 것은 아닌지 점검이 필요해보인다.\n\n\n\n\n앞으로의 과제\n\n지금까지의 SRE KPI 개발 과제를 이렇게 정리할 수 있다.\n\n\n목적\n기존 KPI였던 장애 발생 건수/변경 공지 건수인 장애율이 1% 아래로 saturation되면서 이를 대신할 새로운 KPI가 필요해졌다.\n장애율만큼이나 검색 SRE가 일을 잘 하고 있는지, 그로 인해 검색 서비스의 신뢰도가 어떻게 좋아지고 있는지 단순명료하게 보여줄 수 있는 KPI면 좋겠다.\n방식\n장애의 발생~복구만이 아닌 서버 이상 증상의 감지~완화를 측정 데이터로 사용한다.\n의의\n서버 이상 증상 데이터를 사용함으로써 장애 감지 해상도를 높이고 장애 감지 사각지대를 줄일 수 있다.\n기존 KPI인 장애율과 후보 KPI였던 MTTR은 전사 장애 시스템의 데이터를 사용하고, 새로운 KPI인 MTTM은 검색 모니터링 시스템 경보 데이터를 사용한다.\n전사에서 공통으로 사용하고 있는 장애 기준은 서비스 유저 입장을 기준으로 e2e 환경에서의 장애를 측정한다. 반면 우리 검색 SRE에서는 검색 서비스 내 시스템 단위의 안정성, 건강도에 집중하고 있고 이를 위해 검색 서비스 메트릭을 기준으로 장애를 측정한다는 의미가 있다.\nTTM 데이터 수집부터 MTTM 측정까지 전 과정이 자동화되어 있다.\n보완\n평균의 함정을 피하기 위해 10분 이상의 TTM을 중심으로 지표를 계산한다.\n이상 증상의 지속 시간 뿐만 아니라, 규모와 빈도까지 확인하기 위해 보조 지표인 CTTM, DTTM을 개발했다.\n\n\n그럼에도 아래와 같은 고민은 현재 진행형이다.\n\n\n이상 증상 시간이 줄어들어 MTTM/CTTM/DTTM 수치가 작아지는 것은 검색 서비스의 신뢰도가 좋아지고 있다는 좋은 신호이다. 하지만 동시에 경보 커버리지를 유지할 수 있어야 한다. 실제로 이상 증상을 줄이려는 노력도 필요하고, 긍정 오류(false positive) 경보를 줄여서 경보 피로도도 줄여나가되, 우리가 놓치고 있는 경보는 없는지도 계속 살펴보아야 한다.\n장애율의 saturation 기준을 1%로 세팅한 것처럼, MTTM/CTTM/DTTM 지표도 해당 기준을 설정할 수 있을지 고민이 필요하다.\n검색 서비스 장애 자체는 정말 많이 줄었다. 그런데 장애가 줄어든 이유가 트래픽이 완만하게 늘어나면서 서비스 환경이 안정화되고 운영 환경이 좋아진 결과인지, 아니면 검색 SRE가 잘했기 때문인지 어떻게 알 수 있을까? 그리고 장애가 많이 줄어든 이 시점에서 검색 SRE가 여전히 여러 가지 업무를 잘 해내고 있다는 것은 어떻게 증명해낼 수 있을까?\n궁극적으로, 검색 SRE는 어떤 방향을 향해 가야 할까?\n\n\nSRE KPI를 개발하고 설정하는 일은 검색 SRE의 방향성을 보여주고 또 그 방향대로 한 발자국씩 개선되고 있다는 것을 보여준다는 점에서 중요한 업무라는 생각이 들었다. SRE 업무가 잘 진행되고 있다는 느낌만 주는 것이 아니라, 실제 데이터로 검색 서비스 신뢰도가 더욱 좋아지고 있다는 것을 보여줄 수 있는 SRE KPI TF 업무는 앞으로도 계속된다! 많은 고민에 대한 해답을 풀어나가는 모습을 앞으로도 잘 지켜봐주시고, 관련된 문의사항이나 아이디어가 있다면 제보해주시길 바란다.}","rawText":"\nMTTM 개발기\n개발 배경\nMTTR이란\n전사 장애 시스템의 장애 관제 방식\nMTTR 지표 사용의 한계\n새로운 지표 MTTM\nTTM 지표 측정\n끝날 때까지 끝난 게 아닌 SRE KPI 개발 여정\nKPI 개발 끝, 행복 시작?\n평균의 함정\n새로운 지표 CTTM, DTTM의 등장\n앞으로의 과제\n\n\n지난 글에서 차세대 검색 모니터링 시스템 개발 여정을 다루었습니다. 이번 편에서는 SRE KPI 개발기에 대해 이야기해보려고 합니다.\n\n검색 SRE팀에서는 검색 서비스의 장애를 예방하고 서비스 신뢰도를 높이기 위해 여러 관련 시스템도 개발하고 on-call 업무도 진행하는 등 이곳저곳에서 바쁘게 움직이고 있습니다. 저희의 이런 노력과 검색 서비스 모든 담당자분들의 노고 덕분에 검색 서비스 신뢰도와 안정성은 계속해서 개선되고 있는데요, 그렇다면 얼마나 개선되었는지는 어떻게 알 수 있을까요? 단순히 운이 좋아서 수치가 개선된 것이 아니라 여러 사람들의 노력으로 인해 좋아졌다는 것은 어떻게 보여줄 수 있을까요?\n\n이런 물음에 답하기 위해 검색 SRE팀에서는 검색 서비스의 건강도를 측정하고, 장애 상황에 신속하게 대응하기 위한 여러 가지 방법을 연구하고 발전시켜나가고 있습니다. 이번 검색 SRE 2부 아티클을 통해 지난 몇 년간 내부적으로 논의하고 사용해본 방법들에 대한 이야기를 나누어보고자 합니다.\n\n우선, 검색 서비스의 건강도에 관해 이야기해보고자 합니다. 검색 서비스의 건강도란 무엇을 의미하는 걸까요? 어떤 서비스가 건강한지에 대해서는 어떻게 알 수 있을까요? 가장 간단하고 직접적인 방법은 서비스를 운영하는 장비의 지표(CPU, 메모리, 네트워크 TX/RX 등)를 확인하는 방법이 있을 것입니다. 그런데, 네이버 검색 서비스는 매우 많은 시스템으로 구성되어 있고, 따라서 모든 장비의 지표를 일일이 확인하여 서비스의 건강도를 파악하는 것은 몹시 고되고 비효율적인 작업입니다.\n\n숲에 있는 나무 하나하나의 건강을 챙기는 것도 중요하지만, 숲 전체의 건강을 챙기는 것 역시 중요합니다. 이는 곧, 저희 검색 SRE팀의 목표 그리고 존재 의의라고 할 수 있겠습니다. 좀 더 직관적으로 서비스 전체의 건강도를 파악하기 위해 저희가 시도했던 노력, 그리고 그 과정에서 도출한 지표들에 대해 소개해드리겠습니다.\n\n\n\nMTTM 개발기\n\n\n\n개발 배경\n\n검색 SRE팀에서는 장애율(장애 발생 건수/변경 공지 건수) 지표를 KPI로 사용하고 있다. 서비스의 장애 대부분이 변경 배포 와중에, 혹은 배포 이후 발생하는 것에서 착안한 지표이다. 매우 단순하면서도 효과적으로 검색 서비스 전반의 건강도를 알 수 있는 지표이다.\n\n\n\n검색 SRE가 지원 중인 부서 기준으로 2019년부터 장애율 1% 이하를 유지하고 있다. 특히 2020년에는 0.45% 장애율을 달성했고 이는 변경 공지 200건당 약 1건 이하의 장애 발생을 의미한다. 장애율을 줄이는 것은 중요하지만 장애율을 0%로 줄이는 것은 불가능한 일이기에, 1% 이하의 장애율은 현실적으로 달성하기 어려운 수치를 이루어낸 것이며 앞으로의 지표 개선은 한계가 있다고 판단했다. 따라서 자연스럽게 새로운 KPI 개발의 필요성이 대두되었다.\n\n가장 먼저 논의된 지표는 MTTR(mean time to recovery)이다.\n\n\n\nMTTR이란\n\n장애가 발생하지 않도록 하는 것도 중요하지만, 장애가 발생했을 때 신속하게 복구하는 것도 중요하다. 장애가 발생했을 때 복구까지 걸리는 시간의 평균을 MTTR이라고 하며, 이 지표를 줄여나간다는 것은 신속한 장애 대처 능력을 갖춘다는 것을 의미한다. MTTR은 네이버 전사 장애 시스템에 기록된 장애 티켓의 장애 발생 시각~복구 완료 시각을 하나의 TTR 데이터로 측정하여 산출한다.\n\n위 방식을 통해 검색 SRE가 지원 중인 부서 기준으로 2018년 이후의 MTTR을 살펴보면 매년 1시간이 넘어간다는 것을 확인했다. 실제로 검색 서비스에서 1시간 이상 장애가 지속되었던 케이스는 없었기 때문에 해당 MTTR은 신속한 장애 복구 능력을 나타내는 지표로 사용하기에는 어렵다는 것을 알 수 있다. 먼저 전사 장애 시스템의 장애 관제 방식에 대해서 살펴보겠다.\n\n\n\n전사 장애 시스템의 장애 관제 방식\n\n먼저 전사 장애 시스템에서 장애를 감지하는 경로는 3가지이다.\n\n\n서비스 모니터링 툴을 이용하여 실시간으로 장애 감지\n고객센터로 인입된 고객 문의나 자체 판단 기준을 통해 감지\n장애센터로 인입되는 전사 임직원의 문의를 통해 감지\n\n\n이 중 엔지니어의 개입 없이 자동적으로 장애를 감지하는 방법은 서비스 모니터링 툴을 이용한 장애 감지이다. 그렇다면 현재 서비스 모니터링 툴에서는 검색 서비스에 대해서 어떤 방식으로 장애 감지를 하고 있을까? 모니터링하고자 하는 특정 URL을 지정하고, 해당 페이지에서 등장해야 하는 오브젝트를 지정함으로써 해당 오브젝트가 존재하는지 판단한다. 즉, 특정 주기마다 해당 페이지의 정상 출력 여부에 대한 모니터링을 진행하고 있다.\n\n예를 들면, 이미지 검색이 잘 되는지 확인하기 위해 아래와 같이 '네이버'라는 테스트 검색어로 검색을 진행하고 이미지 탭에서 결과가 잘 나오는지 확인할 수 있다.\n\n\n\n\n\nMTTR 지표 사용의 한계\n\n위와 같은 방식으로 장애를 감지하고, 서비스 장애의 복구 시간을 나타내는 MTTR을 검색 SRE의 신속한 장애 복구 능력을 나타내는 지표로 사용하는 것에는 몇 가지 어려움이 있었다.\n\n\n장애 감지 사각지대 존재\n\n담당자가 위 감지 조건을 직접 튜닝해야 한다. 감지 조건 튜닝을 잘한 서비스는 그만큼 장애가 잘 관측되지만, 그렇지 않은 서비스는 잘 관측되지 않는다.\n새로 출시된 서비스일수록 상대적으로 조건 튜닝의 디테일이 부족하기 때문에 감지의 사각지대가 생길 수 있다.\n서비스별 장애 감지 조건의 차이와 서비스/시스템 관점에서의 지표 산출\n\n검색 SRE는 모든 서비스의 장애 복구 시간을 한눈에 볼 수 있는 특정 지표로 환산하고자 한다. 따라서 '서비스'의 관점에서 모두 각기 다른 감지 조건을 설정하여 장애를 감지하고 이를 지표로 산출하기보다는, '시스템'의 관점에서 일관성 있고 객관적인 방식의 장애 감지와 그에 따른 지표 산출이 필요하다고 판단했다.\n표본 수 부족\n\n절대적인 표본 수 부족\n검색 SRE가 지원 중인 부서 기준 매년 장애 건수는 00건 이하이다. 표본의 수가 부족하다는 것은 결국 통계적으로 신뢰도가 낮다는 문제로 연결된다.\n표본 수의 감소 추세\n위 표본 수가 부족한 문제는 검색 SRE 활동을 통해 장애율을 줄여나감에 따라 더욱 심해진다. 기존 KPI에서 장애 발생 건수/변경 공지 건수를 줄여 1% 이하의 장애율을 달성했는데, 이 말은 결국 MTTR의 표본인 장애 건수의 감소를 의미한다.\n이상값(outlier)에 의한 지표의 변화\n분석한 장애 데이터의 복구 시간은 최소 0분~최대 0000분으로 범위가 매우 넓다. 표본이 적다는 문제는 worst case의 이상값에 의한 값의 왜곡 현상을 심화시킨다.\n\n\n\n\n새로운 지표 MTTM\n\n따라서 위 3가지 문제점을 해결하며, 신속한 장애 복구 능력을 지표화할 수 있는 방식에 대해서 고민했다. 이때 '장애의 발생~복구만이 아닌 서버 이상 증상의 감지~완화를 측정 데이터로 사용하면 어떨까?'라는 아이디어에서 MTTM의 개념이 등장했다.\n\n\n\nMTTM(mean time to mitigation)이란 서버의 이상 증상이 감지되어 경보가 발생한 시점부터 증상의 완화(mitigation) 시점까지 걸린 시간의 평균을 의미한다.\n\nMTTM은 검색 모니터링 시스템의 Event 데이터를 사용하여 지표를 산출했다.(1편에서 소개한 바로 그 검색 모니터링 시스템이다.) 검색 모니터링 시스템에서는 장애 및 이상 증상에 대한 일관성있고 고도화된 감지를 통해 사용자에게 Event를 알려준다. 또한 수년간의 이상 증상에 대한 데이터가 아카이빙 되어있으며, 표본 수도 많고 정확도도 높다. Event는 아래와 같은 종류가 있으며, 각 Event의 발동과 해제 기준은 모든 검색 서비스에 동일하게 적용된다.\n\n\n트래픽 경보\n가용량 부족\n시간 초과 발생\n평균 응답 시간 지연\n\n\n\n\nTTM 지표 측정\n\n전사 장애 기준에는 미치지 못했으나 검색 모니터링 시스템에 관측된 한 가지 이상 증상 케이스를 예로 설명하겠다.(경보 시간, CPU 사용률 등 구체적인 수치는 예시이다.) 잘못된 배포로 인하여 특정 서버의 CPU 사용률이 급격히 상승했고 이에 따라 연결 시간 초과(connection timeout)이 발생했던 케이스이다. 운영자는 이를 인지하여 수 분내에 롤백 조치를 했다.\n\n\n\n검색 모니터링 시스템에서는 해당 Event를 가용량이 부족한 이상 증상으로 규정하고 있다. 이에 따라 임계점(threshold)을 넘어간 시점에 경보를 발생시키고, 증상이 완화된 시점에는 경보를 해제한다. 우리는 경보의 발동부터 해제까지를 time to mitigation(완화까지의 시간)으로 정하고, 모든 이상 증상의 TTM 평균인 MTTM(mean time to mitigation)을 사용한다.\n\n해당 케이스의 경우 17시 25분에 경보가 발동하여 17시 35분에 해제되었으므로 TTM은 10분으로 계산된다.\n\n\n\n더욱 자세한 내용은 해당 주제로 발표를 진행했던 DEVIEW 2021 세션에서 확인할 수 있다.\n\n\n\n끝날 때까지 끝난 게 아닌 SRE KPI 개발 여정\n\n\n\nKPI 개발 끝, 행복 시작?\n\n이렇게 MTTM이라는 새로운 지표를 만들고 적용한 지 일 년이 흘러 살펴본 지표는 아래와 같았다.\n\n\n\n그런데 정말로 \"최근 검색 서비스의 이상 증상이 해소되기까지 평균적으로 약 10분 정도 소요된다\"라고 해석해도 괜찮은 걸까?\n\n\n\n평균의 함정\n\n경험을 통해 대강 짐작하고 있는 경보의 지속 시간과 'MTTM 5~10분'은 검색 SRE 입장에서는 조금 괴리가 있다고 느껴졌다. 왜 그런지 경보 데이터를 살펴보니 일시적으로 1~2분 튀었다가 경보가 해제되는 경우가 전체 경보의 절반 이상을 차지하고 있었고, 그에 따라 우리는 MTTM이 더 낮은 수치를 보여줄 것이라고 기대하고 있던 것이다. 이상 증상이 해소되기까지 오래 걸리는 몇몇 이상값으로 인해 10분이라는 수치로 계산되었기에, 이는 '평균의 함정'이라고도 해석이 가능했다.\n\n그리고 1~2분 경보 데이터는 정말로 '경보'일까? 아니면 일시적으로 튀는 이상 증상이니 경보 상황으로 보지 않아야 하는걸까? 2분 이하 경보 케이스를 하나씩 살펴보면 실제로 장애로 이어질 수 있었던 경보 상황은 많지 않았고, 배포나 하드웨어 이슈 등으로 일시적으로 수치가 튀었다가 다시 정상으로 돌아오는 경우가 많았다. 그렇지만 실제로 장애였던 케이스도 분명 존재했다.\n\n논의 끝에 대표 MTTM은 10분 이상의 경보 데이터를 기준으로 계산하는 것으로 결정했다. 이러한 기준은 10분 이상의 경보와 이상 증상에 대해서 더 집중해서 먼저 살펴보겠다는 의지가 담겨 있기도 하다.\n\n10분 이상의 경보 데이터로 MTTM을 다시 계산하면 아래와 같다. 전체 TTM의 평균보다 최대 6배 정도 수치가 증가한다.\n\n\n\n그런데 TTM >= 10분 MTTM을 본다고 하더라도, 아래 두 가지 문제는 여전히 고민이 필요하다.\n\n\n여전히 평균값을 사용하기 때문에 '평균의 함정'에서는 벗어날 수 없다. 짧은 경보 상황이 많이 발생할수록 지표가 좋아지거나, 이상값 몇 개가 지표를 악화시키는 문제는 여전히 존재한다.\n짧은 시간 지속되는 경보 상황이 많은 것에 대해서는 \"경보 시간이 긴 것 보다는 짧은 게 좋은 것 아닌가?\"라는 생각이 자연스럽게 떠오르지만, 경보가 '많은' 것이 건강한 시스템 상황이라고 볼 수 있을지는 고민이 필요하다.\n\n\n이에 대한 예시로, 위 2020년 MTTM을 다시 살펴보면 TTM 필터링에 따라 다른 양상을 보인다는 것을 확인할 수 있다. 전체 TTM을 대상으로 한 MTTM의 경우 2019년보다 작고 2021년보다 크지만, 10분 이상 TTM을 대상으로 한 MTTM의 경우 2019년, 2021년보다 확연히 큰 값을 보여준다.\n\n그리고 10분 미만의 TTM 비율이 늘어나고 있는 것도 확인할 수 있었다. 짧은 시간의 경보가 많아지고 있는 것이다.\n\n\n\n이에 대해, MTTM 값이 낮다고 해서 시스템이 건강하다고 판단하기는 어렵다는 결론을 내렸다. 이 문제를 해결하기 위해 평균값만 보는것이 아니라 이상 증상의 규모나 빈도를 함께 살펴볼 수 있는 보조 지표를 추가해보자는 의견이 나왔다.\n\n\n\n새로운 지표 CTTM, DTTM의 등장\n\n규모를 확인할 수 있는 가장 간단한 방법은 그 합계 값을 확인하는 것이다. 우리도 이에 따라 보조 지표인 CTTM, DTTM을 만들었다.\n\n\nCTTM: 누적 TTM. TTM을 단순 합산한 것. 이상 증상의 전체 규모를 숫자 하나로 파악할 수 있음\nDTTM: Duration TTM. 경보끼리의 중복 시간을 제거해서 구한 전체 TTM 합.\n\n\n즉, 예를 들어 지속 시간 1분짜리 경보 3개가 동시에 울렸다면 CTTM은 3분, DTTM은 1분으로 계산한다.\n\n\n\n전체 합산값인 CTTM은 경보의 전체적인 규모를 파악하기 위한 지표라는 것을 알겠는데, 그렇다면 DTTM은 어떤 목적으로 만들어진 지표일까?\n\n검색 SRE에서는 200여 개가 넘는 검색 서비스가 운영되고 있고, 경보의 종류도 다양하다. 따라서 단순히 합산값만 구하면 1년 중 몇 퍼센트의 시간만큼 이상 증상이 있었는지 직관적으로 확인하기가 어렵다. 예를 들어 여러 종류의 경보가 여러 서비스에서 많이 발생한다면 연간 CTTM 기준으로 1년을 넘어가는 값이 나올 수도 있다.\n\n그러나 DTTM은 '이 시간에 이상 증상이 있었는지 없었는지'를 기준으로 하기 때문에 기준시간 대비 100%를 초과하는 값이 나올 수 없다. 이를 통해 검색 서비스 전체 *이상 증상의 budget도 확인할 수 있게된다.\n\n\n  * 이상 증상의 budget: 이상 증상 시간의 총합. 시스템 다운타임의 최대값을 뜻하는 error budget에서 착안한 단어.\n\n\n그리고 DTTM을 확인하며 각 시간에 얼마나 많은 이상 증상이 겹쳐서 일어났는지도 확인할 수 있다. 만일 같은 시간에 여러 서비스 혹은 여러 이상 증상이 동시에 나타나면 SPOF(single point of failure)과 같이 광범위하게 영향을 미치는 이상 증상이 있었다는 것을 확인할 수 있다. 이는 큰 영향을 주는 이상 증상이나 장애를 추적하고 예방하는 것에도 도움이 될 수 있을 것이라고 생각했다.\n\n\n\n\n\n위 그래프를 통해 알 수 있는 우리 시스템의 건강도 상황은 다음과 같다.\n\n\n22년을 기준으로 10분 이상의 이상 증상 평균 지속 시간은 65분이다. 이상 증상 규모는 약 1% 정도였다.\n반면 CTTM과 DTTM 두 가지 지표를 비교하면 DTTM이 더 빠르게 작아지고 있는것을 확인할 수 있다. 22년도에는 대략 0.5% 정도까지 차이가 나기도 한다. 이는 여러 서비스에서 여러 이상 증상이 동시에 발생하는 비율이 더 커지고 있음을 나타낸다고 볼 수 있다. 이상 증상이 동시에 발생한 시간과 그 내용을 확인하여, 하나의 증상이 여러 서비스에 영향을 미치고 있는 것은 아닌지 점검이 필요해보인다.\n\n\n\n\n앞으로의 과제\n\n지금까지의 SRE KPI 개발 과제를 이렇게 정리할 수 있다.\n\n\n목적\n기존 KPI였던 장애 발생 건수/변경 공지 건수인 장애율이 1% 아래로 saturation되면서 이를 대신할 새로운 KPI가 필요해졌다.\n장애율만큼이나 검색 SRE가 일을 잘 하고 있는지, 그로 인해 검색 서비스의 신뢰도가 어떻게 좋아지고 있는지 단순명료하게 보여줄 수 있는 KPI면 좋겠다.\n방식\n장애의 발생~복구만이 아닌 서버 이상 증상의 감지~완화를 측정 데이터로 사용한다.\n의의\n서버 이상 증상 데이터를 사용함으로써 장애 감지 해상도를 높이고 장애 감지 사각지대를 줄일 수 있다.\n기존 KPI인 장애율과 후보 KPI였던 MTTR은 전사 장애 시스템의 데이터를 사용하고, 새로운 KPI인 MTTM은 검색 모니터링 시스템 경보 데이터를 사용한다.\n전사에서 공통으로 사용하고 있는 장애 기준은 서비스 유저 입장을 기준으로 e2e 환경에서의 장애를 측정한다. 반면 우리 검색 SRE에서는 검색 서비스 내 시스템 단위의 안정성, 건강도에 집중하고 있고 이를 위해 검색 서비스 메트릭을 기준으로 장애를 측정한다는 의미가 있다.\nTTM 데이터 수집부터 MTTM 측정까지 전 과정이 자동화되어 있다.\n보완\n평균의 함정을 피하기 위해 10분 이상의 TTM을 중심으로 지표를 계산한다.\n이상 증상의 지속 시간 뿐만 아니라, 규모와 빈도까지 확인하기 위해 보조 지표인 CTTM, DTTM을 개발했다.\n\n\n그럼에도 아래와 같은 고민은 현재 진행형이다.\n\n\n이상 증상 시간이 줄어들어 MTTM/CTTM/DTTM 수치가 작아지는 것은 검색 서비스의 신뢰도가 좋아지고 있다는 좋은 신호이다. 하지만 동시에 경보 커버리지를 유지할 수 있어야 한다. 실제로 이상 증상을 줄이려는 노력도 필요하고, 긍정 오류(false positive) 경보를 줄여서 경보 피로도도 줄여나가되, 우리가 놓치고 있는 경보는 없는지도 계속 살펴보아야 한다.\n장애율의 saturation 기준을 1%로 세팅한 것처럼, MTTM/CTTM/DTTM 지표도 해당 기준을 설정할 수 있을지 고민이 필요하다.\n검색 서비스 장애 자체는 정말 많이 줄었다. 그런데 장애가 줄어든 이유가 트래픽이 완만하게 늘어나면서 서비스 환경이 안정화되고 운영 환경이 좋아진 결과인지, 아니면 검색 SRE가 잘했기 때문인지 어떻게 알 수 있을까? 그리고 장애가 많이 줄어든 이 시점에서 검색 SRE가 여전히 여러 가지 업무를 잘 해내고 있다는 것은 어떻게 증명해낼 수 있을까?\n궁극적으로, 검색 SRE는 어떤 방향을 향해 가야 할까?\n\n\nSRE KPI를 개발하고 설정하는 일은 검색 SRE의 방향성을 보여주고 또 그 방향대로 한 발자국씩 개선되고 있다는 것을 보여준다는 점에서 중요한 업무라는 생각이 들었다. SRE 업무가 잘 진행되고 있다는 느낌만 주는 것이 아니라, 실제 데이터로 검색 서비스 신뢰도가 더욱 좋아지고 있다는 것을 보여줄 수 있는 SRE KPI TF 업무는 앞으로도 계속된다! 많은 고민에 대한 해답을 풀어나가는 모습을 앞으로도 잘 지켜봐주시고, 관련된 문의사항이나 아이디어가 있다면 제보해주시길 바란다.}","href":"https://d2.naver.com/d2.atom네이버 검색 SRE 2편 - 측정하지 않으면 개선할 수 없다! SRE KPI 개발기"}